FROM php:7.2-alpine

# Environmental Variables
ENV COMPOSER_HOME /root/composer
ENV COMPOSER_VERSION master
ENV COMPOSER_ALLOW_SUPERUSER 1

RUN buildDeps=' \
    bash \
    git \
    g++ \
    make \
    cmake \
    libstdc++ \
    libc-dev \
    pcre-dev \
    autoconf \
    re2c \
    file \
    sudo \
    ' \
    && apk add --no-cache --update $buildDeps \
    && docker-php-source extract \
    && pecl install xdebug

ENV PHP_ZEPHIR_PARSER v1.1.3

RUN git clone --branch ${PHP_ZEPHIR_PARSER} https://github.com/phalcon/php-zephir-parser.git /tmp/php-zephir-parser \
    && cd /tmp/php-zephir-parser \
    && phpize && ./configure \
    && make -j4 \
    && make install \
    && rm -rf /tmp/* \
    && echo "extension=zephir_parser.so" > /usr/local/etc/php/conf.d/zephir.ini


RUN curl -L https://github.com/phalcon/zephir/releases/download/0.11.4/zephir.phar --output /tmp/zephir.phar

# Copy custom configuration
COPY xdebug-cli.ini /usr/local/etc/php/conf.d/

WORKDIR /app

# Set up the application directory
VOLUME ["/app"]
ENTRYPOINT ["php", "/tmp/zephir.phar"]
